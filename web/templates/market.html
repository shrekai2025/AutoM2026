{% extends "base.html" %}

{% block content %}
<div class="container animate-fade-in">
    <div class="h-4"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Add token form handler
            const form = document.getElementById('add-token-form');
            if (form) {
                form.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const formData = new FormData(form);
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalBtnContent = submitBtn.innerHTML;

                    // Show loading state
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="loader border-2 border-current border-t-transparent rounded-full w-4 h-4 inline-block animate-spin mr-2"></span>Loading...';

                    try {
                        const response = await fetch(form.action, {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            window.location.reload();
                        } else {
                            const error = await response.json();
                            ui.alert(error.detail || 'Failed to add token', 'Error');
                        }
                    } catch (err) {
                        console.error('Error adding token:', err);
                        ui.alert('Network error or server unreachable', 'Error');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnContent;
                    }
                });
            }
        });
    </script>
</div>

<div x-data="{ activeTab: 'indicators', activeFilter: 'all' }"
    style="display: flex; flex-direction: column; gap: 1.5rem;">

    <!-- Tabs -->
    <div
        style="display: inline-flex; gap: 0.25rem; background: rgba(15,23,42,0.6); backdrop-filter: blur(12px); padding: 0.375rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.08); max-width: 320px; margin: 0 auto;">
        <button @click="activeTab = 'indicators'" :style="activeTab === 'indicators' 
                    ? 'background: rgba(59,130,246,0.9); color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3);' 
                    : 'background: transparent; color: rgba(148,163,184,0.9);'"
            style="flex: 1; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border: none; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">
            <i class="ph-bold ph-chart-line-up" style="font-size: 1rem;"></i>
            <span data-i18n="market.tab.indicators">核心指标</span>
        </button>
        <button @click="activeTab = 'price'" :style="activeTab === 'price' 
                    ? 'background: rgba(59,130,246,0.9); color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3);' 
                    : 'background: transparent; color: rgba(148,163,184,0.9);'"
            style="flex: 1; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border: none; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">
            <i class="ph-bold ph-list-dashes" style="font-size: 1rem;"></i>
            <span data-i18n="market.tab.price">价格清单</span>
        </button>
    </div>

    <!-- Tab Content: Indicators -->
    <div x-show="activeTab === 'indicators'" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

        <!-- Tags Filter -->
        <div class="flex flex-wrap gap-2 mb-6 ml-1">
            <button @click="activeFilter = 'all'"
                :class="activeFilter === 'all' ? 'btn-primary shadow-sm' : 'btn-ghost opacity-60 hover:opacity-100 bg-base-200/50'"
                class="btn btn-xs sm:btn-sm rounded-full px-4 border-none transition-all">全部分类</button>
            <button @click="activeFilter = 'BTC'"
                :class="activeFilter === 'BTC' ? 'btn-primary shadow-sm' : 'btn-ghost opacity-60 hover:opacity-100 bg-base-200/50'"
                class="btn btn-xs sm:btn-sm rounded-full px-4 border-none transition-all">BTC</button>
            <button @click="activeFilter = 'ETF'"
                :class="activeFilter === 'ETF' ? 'btn-primary shadow-sm' : 'btn-ghost opacity-60 hover:opacity-100 bg-base-200/50'"
                class="btn btn-xs sm:btn-sm rounded-full px-4 border-none transition-all">ETF</button>
            <button @click="activeFilter = '矿业'"
                :class="activeFilter === '矿业' ? 'btn-primary shadow-sm' : 'btn-ghost opacity-60 hover:opacity-100 bg-base-200/50'"
                class="btn btn-xs sm:btn-sm rounded-full px-4 border-none transition-all">矿业</button>
            <button @click="activeFilter = '链上'"
                :class="activeFilter === '链上' ? 'btn-primary shadow-sm' : 'btn-ghost opacity-60 hover:opacity-100 bg-base-200/50'"
                class="btn btn-xs sm:btn-sm rounded-full px-4 border-none transition-all">链上</button>
            <button @click="activeFilter = '估值'"
                :class="activeFilter === '估值' ? 'btn-primary shadow-sm' : 'btn-ghost opacity-60 hover:opacity-100 bg-base-200/50'"
                class="btn btn-xs sm:btn-sm rounded-full px-4 border-none transition-all">估值</button>
            <button @click="activeFilter = '美股'"
                :class="activeFilter === '美股' ? 'btn-primary shadow-sm' : 'btn-ghost opacity-60 hover:opacity-100 bg-base-200/50'"
                class="btn btn-xs sm:btn-sm rounded-full px-4 border-none transition-all">美股</button>
            <button @click="activeFilter = '宏观'"
                :class="activeFilter === '宏观' ? 'btn-primary shadow-sm' : 'btn-ghost opacity-60 hover:opacity-100 bg-base-200/50'"
                class="btn btn-xs sm:btn-sm rounded-full px-4 border-none transition-all">宏观</button>
            <button @click="activeFilter = '资金'"
                :class="activeFilter === '资金' ? 'btn-primary shadow-sm' : 'btn-ghost opacity-60 hover:opacity-100 bg-base-200/50'"
                class="btn btn-xs sm:btn-sm rounded-full px-4 border-none transition-all">资金</button>
            <button @click="activeFilter = '情绪'"
                :class="activeFilter === '情绪' ? 'btn-primary shadow-sm' : 'btn-ghost opacity-60 hover:opacity-100 bg-base-200/50'"
                class="btn btn-xs sm:btn-sm rounded-full px-4 border-none transition-all">情绪</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            {% for ind in macro_indicators %}
            <a href="/market/indicator/{{ ind.abbr }}"
                x-show='activeFilter === "all" || ({{ ind.tags|tojson|safe }} || []).includes(activeFilter)'
                x-transition:enter="transition-opacity duration-300" style="text-decoration: none; color: inherit;">
                <div class="card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 border border-base-200/50"
                    style="cursor: pointer;">
                    <div class="card-body p-5">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1 min-w-0 pr-2">
                                <h2 class="text-lg font-bold truncate">
                                    <span class="show-zh-only">{{ ind.name_zh }}</span>
                                    <span class="show-en-only">{{ ind.name_en }}</span>
                                </h2>
                                <div class="text-xs text-base-content/60 font-mono mt-0.5 flex items-center gap-1">
                                    {{ ind.abbr }}
                                    {% if ind.desc %}
                                    <span class="opacity-50">•</span>
                                    <span class="truncate">{{ ind.desc }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="badge badge-soft badge-sm mt-0.5 shrink-0 font-mono opacity-70">{{ ind.abbr
                                    }}</div>
                                <i class="ph ph-arrow-right"
                                    style="font-size: 1rem; color: var(--muted-foreground); opacity: 0.5;"></i>
                            </div>
                        </div>

                        <div class="flex items-baseline gap-2 mt-2">
                            <div class="text-3xl font-black tracking-tight {{ ind.class }}">
                                {{ ind.value }}
                            </div>
                            {% if ind.sub_value %}
                            <div class="text-sm font-bold opacity-60 bg-base-200/50 px-2 py-0.5 rounded">
                                {{ ind.sub_value }}
                            </div>
                            {% endif %}
                        </div>

                        {% if ind.tags %}
                        <div class="mt-4 flex flex-wrap gap-1">
                            {% for t in ind.tags %}
                            <span class="badge badge-soft badge-sm opacity-60 bg-base-200 border-none text-[10px]">{{ t
                                }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </a>

            {% endfor %}

            {% if not macro_indicators %}
            <div
                class="col-span-full text-center py-16 opacity-60 border-2 border-dashed border-base-300 rounded-xl bg-base-200/30">
                <i class="ph-bold ph-chart-bar text-5xl mb-3 text-base-content/30"></i>
                <div class="font-medium" data-i18n="status.noData">暂无数据</div>
                <div class="text-xs mt-1 text-base-content/50">请配置 FRED API Key 以获取宏观数据</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tab Content: Price Checklist -->
    <div x-show="activeTab === 'price'" style="display: none;" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

        <!-- Price Tab Header: Title & Add Form -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-5 gap-4">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="ph-bold ph-monitor text-primary"></i>
                    <span data-i18n="market.title">行情监控</span>
                </h1>
            </div>

            <!-- Add Token Form -->
            <form id="add-token-form" action="/market/add" method="post" class="flex gap-2 w-full sm:w-auto">
                <div class="flex gap-2 w-full">
                    <input type="text" name="symbol"
                        class="input input-sm sm:input-md input-bordered uppercase w-full sm:w-48 transition-all focus:w-64"
                        placeholder="Symbol (e.g. BTC)" required>
                    <button type="submit" class="btn btn-sm sm:btn-md btn-primary" id="add-btn">
                        <i class="ph-bold ph-plus"></i>
                        <span data-i18n="action.add">添加</span>
                    </button>
                </div>
            </form>
        </div>
        <script>
            // Form handler script moved here or kept global? 
            // It's safe to keep the global script listener if IDs match.
            // Re-attaching logic might be needed if DOM is replaced, but x-show just toggles visibility.
        </script>

        <div class="card bg-base-100 shadow-sm border border-base-200">
            <div class="card-content p-0">
                <div class="table-container">
                    <table id="market-table" class="table table-zebra w-full">
                        <thead>
                            <tr class="bg-base-200/50 text-xs uppercase tracking-wider text-base-content/60">
                                <th style="width: 40px;"></th>
                                <th data-i18n="market.symbol">标的</th>
                                <th class="text-right" data-i18n="market.price">当前价格</th>
                                <th class="text-right" data-i18n="market.change_24h">24h 涨跌幅</th>
                                <th class="text-right" data-i18n="market.high_24h">24h 最高</th>
                                <th class="text-right" data-i18n="market.low_24h">24h 最低</th>
                                <th class="text-right" data-i18n="market.volume_24h">24h 成交量</th>
                                <th class="text-right" data-i18n="strategy.actions">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in market_data %}
                            <tr data-id="{{ item.id }}" class="hover">
                                <td class="drag-handle cursor-move text-base-content/30 hover:text-base-content">
                                    <i class="ph-bold ph-dots-six-vertical"></i>
                                </td>
                                <td class="font-bold">
                                    {{ item.symbol }}/USDT
                                </td>

                                {% if item.valid %}
                                <td class="text-right font-mono">
                                    <div class="flex items-center justify-end gap-1.5">
                                        ${{ "%.2f"|format(item.price) }}
                                        <span class="live-indicator connected w-2 h-2"></span>
                                    </div>
                                </td>
                                <td class="text-right">
                                    <span
                                        class="badge badge-sm font-bold {{ 'badge-success text-success-content' if item.price_change_24h >= 0 else 'badge-error text-error-content' }}">
                                        {{ "+" if item.price_change_24h >= 0 else "" }}{{
                                        "%.2f"|format(item.price_change_24h) }}%
                                    </span>
                                </td>
                                <td class="text-right font-mono opacity-80">${{ "%.2f"|format(item.high_24h) }}</td>
                                <td class="text-right font-mono opacity-80">${{ "%.2f"|format(item.low_24h) }}</td>
                                <td class="text-right font-mono opacity-60">{{ "{:,.0f}".format(item.volume_24h) }}</td>
                                {% else %}
                                <td colspan="5" class="text-center text-muted">
                                    <span class="badge badge-ghost opacity-50"
                                        data-i18n="status.unavailable">暂无法获取数据</span>
                                </td>
                                {% endif %}

                                <td class="text-right">
                                    <div class="flex items-center justify-end gap-1">
                                        <form action="/market/{{ item.id }}/toggle_star" method="post"
                                            style="display:inline;">
                                            <button type="submit"
                                                class="btn btn-sm btn-ghost btn-square {{ 'text-warning' if item.is_starred else 'opacity-30 hover:opacity-100' }}"
                                                title="Toggle Star">
                                                <i class="{{ 'ph-fill' if item.is_starred else 'ph-bold' }} ph-star"
                                                    style="font-size: 16px;"></i>
                                            </button>
                                        </form>

                                        <form action="/market/delete" method="post" style="display:inline;"
                                            onsubmit="event.preventDefault(); const form = this; ui.confirm(t('msg.confirm_delete'), () => form.submit());">
                                            <input type="hidden" name="id" value="{{ item.id }}">
                                            <button type="submit"
                                                class="btn btn-sm btn-ghost btn-square text-error hover:bg-error/10"
                                                title="Remove">
                                                <i class="ph-bold ph-trash" style="font-size: 16px;"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center text-base-content/50 py-12">
                                    <i class="ph-bold ph-list-dashes text-3xl mb-2 block opacity-30"></i>
                                    <span data-i18n="status.noData">暂无监控，请添加代币</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
<script>
    const el = document.querySelector('#market-table tbody');
    if (el) {
        Sortable.create(el, {
            handle: '.drag-handle',
            animation: 150,
            onEnd: async function (evt) {
                // Get all IDs in new order
                const rows = Array.from(el.querySelectorAll('tr[data-id]'));
                const order = rows.map(row => parseInt(row.dataset.id));

                if (order.length > 0) {
                    try {
                        const response = await fetch('/api/market/reorder', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ order: order })
                        });

                        if (!response.ok) {
                            console.error('Failed to save order');
                        }
                    } catch (err) {
                        console.error('Error saving order:', err);
                    }
                }
            }
        });
    }
</script>
{% endblock %}