# Phase 1 æ ¸å¿ƒéª¨æ¶ â€” ä½¿ç”¨æŒ‡å—

> AutoM2026 v3 Phase 1 æ–°å¢åŠŸèƒ½çš„å®Œæ•´è¯´æ˜ï¼ŒåŒ…æ‹¬é£æ§ç³»ç»Ÿã€é€šçŸ¥ç³»ç»Ÿã€æ•°æ®è´¨é‡æ ¡éªŒã€æ‰§è¡Œå¼•æ“ç­‰ã€‚

---

## ç›®å½•

1. [æ¶æ„æ€»è§ˆ](#1-æ¶æ„æ€»è§ˆ)
2. [ç¯å¢ƒé…ç½® (.env)](#2-ç¯å¢ƒé…ç½®)
3. [é£æ§ç³»ç»Ÿè¯¦è§£](#3-é£æ§ç³»ç»Ÿè¯¦è§£)
4. [æ­¢æŸæ­¢ç›ˆå¼•æ“](#4-æ­¢æŸæ­¢ç›ˆå¼•æ“)
5. [ä»“ä½è®¡ç®—å™¨](#5-ä»“ä½è®¡ç®—å™¨)
6. [æ•°æ®è´¨é‡æ ¡éªŒ](#6-æ•°æ®è´¨é‡æ ¡éªŒ)
7. [Telegram é€šçŸ¥](#7-telegram-é€šçŸ¥)
8. [æ–°å¢ API ç«¯ç‚¹](#8-æ–°å¢-api-ç«¯ç‚¹)
9. [æ•°æ®åº“æ–°å¢è¡¨](#9-æ•°æ®åº“æ–°å¢è¡¨)
10. [å¯¹ç°æœ‰åŠŸèƒ½çš„å½±å“](#10-å¯¹ç°æœ‰åŠŸèƒ½çš„å½±å“)
11. [æ•…éšœæ’æŸ¥](#11-æ•…éšœæ’æŸ¥)

---

## 1. æ¶æ„æ€»è§ˆ

Phase 1 åœ¨ä¸æ”¹å˜å¤–éƒ¨è¡Œä¸ºçš„å‰æä¸‹ï¼Œå°†å†…éƒ¨æµç¨‹ä»ï¼š

```
æ—§æµç¨‹: Strategy.analyze() â†’ ç›´æ¥ paper_engine.execute_trade()
```

å‡çº§ä¸ºï¼š

```
æ–°æµç¨‹: Strategy.analyze()
         â†’ RiskManager.evaluate()     â† é£æ§è¯„ä¼°
           â†’ StopLoss.attach()        â† è‡ªåŠ¨æ­¢æŸ
           â†’ ExecutionEngine.execute_signal()  â† æ ‡å‡†åŒ–æ‰§è¡Œ
             â†’ Telegram é€šçŸ¥           â† äº¤æ˜“/å‘Šè­¦æ¨é€
             â†’ risk_events è®°å½•       â† å®¡è®¡è¿½è¸ª
```

**å…³é”®åŸåˆ™ï¼šç°æœ‰ TA / Macro / Grid ä¸‰ä¸ªç­–ç•¥é›¶æ”¹åŠ¨ï¼Œç…§å¸¸è¿è¡Œã€‚**

---

## 2. ç¯å¢ƒé…ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ˆéƒ½æœ‰é»˜è®¤å€¼ï¼Œä¸é…ä¹Ÿèƒ½è¿è¡Œï¼‰ï¼š

```bash
# ========== é£æ§é…ç½® ==========
# å•ç­–ç•¥æœ€å¤§æŒä»“å æ€»èµ„é‡‘æ¯”ä¾‹ (0.30 = 30%)
RISK_MAX_POSITION_PCT=0.30

# å…¨å±€æœ€å¤§å›æ’¤æ¯”ä¾‹ï¼Œè¶…è¿‡è§¦å‘ç†”æ–­ (0.15 = 15%)
RISK_MAX_DRAWDOWN_PCT=0.15

# å•æ—¥äºæŸä¸Šé™å æ€»èµ„é‡‘æ¯”ä¾‹ (0.05 = 5%)
RISK_DAILY_LOSS_LIMIT_PCT=0.05

# ç†”æ–­å†·å´æ—¶é—´ (å°æ—¶)
RISK_COOLDOWN_HOURS=24

# ========== äº¤æ˜“æ¨¡å¼ ==========
# paper = æ¨¡æ‹Ÿäº¤æ˜“ (é»˜è®¤)
# dry_run = å…¨é“¾è·¯ä½†ä¸çœŸå®ä¸‹å• (Phase 4)
# live = å®ç›˜ (Phase 4)
TRADING_MODE=paper

# ========== Telegram é€šçŸ¥ ==========
# ä¸å¡«åˆ™é€šçŸ¥åŠŸèƒ½è‡ªåŠ¨ç¦ç”¨
TELEGRAM_BOT_TOKEN=ä½ çš„Bot Token
TELEGRAM_CHAT_ID=ä½ çš„Chat ID

# ========== ç»„åˆå¿«ç…§ ==========
# æ¯éš”å¤šå°‘å°æ—¶ä¿å­˜ä¸€æ¬¡ç»„åˆå‡€å€¼å¿«ç…§
PORTFOLIO_SNAPSHOT_HOURS=1
```

### é…ç½®ç”Ÿæ•ˆæ–¹å¼

- æ‰€æœ‰é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡è¯»å–ï¼Œä¿®æ”¹ `.env` åéœ€è¦**é‡å¯æœåŠ¡**æ‰ç”Ÿæ•ˆ
- é£æ§å‚æ•°ç›®å‰ä¸æ”¯æŒè¿è¡Œæ—¶çƒ­æ›´æ–°ï¼ˆè®¡åˆ’åœ¨ Phase 6 å¢åŠ  Web UI é…ç½®ç•Œé¢ï¼‰

---

## 3. é£æ§ç³»ç»Ÿè¯¦è§£

### 3.1 å·¥ä½œåŸç†

é£æ§ç³»ç»Ÿï¼ˆ`risk/risk_manager.py`ï¼‰ä½äºç­–ç•¥å’Œæ‰§è¡Œå¼•æ“ä¹‹é—´ï¼Œ**æ¯ä¸€ç¬”äº¤æ˜“ä¿¡å·éƒ½å¿…é¡»ç»è¿‡é£æ§è¯„ä¼°**ã€‚

è¯„ä¼°æµç¨‹æŒ‰é¡ºåºæ£€æŸ¥ä»¥ä¸‹è§„åˆ™ï¼š

```
ä¿¡å·è¿›å…¥ â†’ â‘ ç†”æ–­æ£€æŸ¥ â†’ â‘¡å›æ’¤æ£€æŸ¥ â†’ â‘¢å•æ—¥äºæŸæ£€æŸ¥ â†’ â‘£æŒä»“æš´éœ²æ£€æŸ¥ â†’ â‘¤è‡ªåŠ¨è¡¥å……æ­¢æŸ â†’ æ”¾è¡Œ
           ä»»ä½•ä¸€æ­¥ä¸é€šè¿‡ â†’ æ‹’ç»ä¿¡å·
```

### 3.2 äº”é“é£æ§è§„åˆ™

| åºå· | è§„åˆ™ | é»˜è®¤é˜ˆå€¼ | è§¦å‘åæœ | ä½•æ—¶æ¢å¤ |
|------|------|----------|----------|----------|
| 1 | ç†”æ–­æ£€æŸ¥ | N/A | å†·å´æœŸå†…æ‹’ç»æ‰€æœ‰é HOLD ä¿¡å· | å†·å´æœŸåˆ°æœŸè‡ªåŠ¨æ¢å¤ï¼Œæˆ–æ‰‹åŠ¨è§£é™¤ |
| 2 | å…¨å±€å›æ’¤ | -15% | **è§¦å‘ç†”æ–­** + æ‹’ç»å½“å‰ä¿¡å· | å†·å´æœŸ 24 å°æ—¶ |
| 3 | å•æ—¥äºæŸ | -5% è´¦æˆ·ä»·å€¼ | æ‹’ç»å½“å‰ä¿¡å· | æ¬¡æ—¥ UTC 0 ç‚¹è‡ªåŠ¨é‡ç½® |
| 4 | æ€»æš´éœ²ä¸Šé™ | 80% è´¦æˆ·ä»·å€¼ | æ‹’ç»ä¹°å…¥ä¿¡å· | å–å‡ºæŒä»“åæš´éœ²ä¸‹é™ |
| 5 | è‡ªåŠ¨æ­¢æŸ | 5% / 10% | è¡¥å…… SL/TP åˆ°ä¿¡å·ä¸­ | ä¸æ‹’ç»ï¼Œåªä¿®æ”¹ |

### 3.3 ç†”æ–­æœºåˆ¶è¯¦è§£

**ç†”æ–­æ˜¯æœ€ä¸¥æ ¼çš„ä¿æŠ¤æœºåˆ¶ã€‚** è§¦å‘åç³»ç»Ÿè¿›å…¥"åªè¯»"çŠ¶æ€ï¼š

- **è§¦å‘æ¡ä»¶**: è´¦æˆ·ä»å†å²å³°å€¼å›æ’¤è¶…è¿‡ `RISK_MAX_DRAWDOWN_PCT`ï¼ˆé»˜è®¤ 15%ï¼‰
- **ç”Ÿæ•ˆæœŸé—´**: æ‰€æœ‰ç­–ç•¥äº§ç”Ÿçš„ä¹°å…¥/å–å‡ºä¿¡å·å‡è¢«æ‹’ç»ï¼Œåªæœ‰ HOLD ä¿¡å·é€šè¿‡
- **æŒç»­æ—¶é—´**: `RISK_COOLDOWN_HOURS` å°æ—¶ï¼ˆé»˜è®¤ 24 å°æ—¶ï¼‰
- **è‡ªåŠ¨æ¢å¤**: å†·å´æœŸåˆ°æœŸåè‡ªåŠ¨è§£é™¤ï¼Œä¸‹ä¸€ç¬”ä¿¡å·æ­£å¸¸è¯„ä¼°
- **æ‰‹åŠ¨è§£é™¤**: é€šè¿‡ API è°ƒç”¨ `POST /api/risk/release-circuit-breaker`

**æ—¥å¿—ç¤ºä¾‹ï¼š**
```
CRITICAL [Risk] ç†”æ–­è§¦å‘: å…¨å±€å›æ’¤ -16.2% è¶…è¿‡é˜ˆå€¼ -15%. å†·å´è‡³ 2026-02-14 12:00:00
WARNING  [Risk] ç†”æ–­æ‹’ç»ä¿¡å·: buy BTC
INFO     [Risk] ç†”æ–­è‡ªåŠ¨è§£é™¤ (å†·å´æœŸåˆ°æœŸ)
```

### 3.4 æŸ¥çœ‹é£æ§çŠ¶æ€

**API æ–¹å¼ï¼š**

```bash
# æŸ¥çœ‹å½“å‰é£æ§çŠ¶æ€
curl http://localhost:8080/api/risk/status
```

è¿”å›ï¼š
```json
{
  "circuit_breaker": {
    "active": false,
    "until": null,
    "reason": ""
  },
  "daily_pnl": 0.0,
  "pending_events_count": 0,
  "config": {
    "max_position_pct": 0.30,
    "max_total_exposure_pct": 0.80,
    "max_drawdown_pct": 0.15,
    "daily_loss_limit_pct": 0.05,
    "cooldown_hours": 24
  }
}
```

**æŸ¥çœ‹é£æ§äº‹ä»¶å†å²ï¼š**

```bash
# æœ€è¿‘ 50 æ¡é£æ§äº‹ä»¶
curl http://localhost:8080/api/risk/events?limit=50
```

è¿”å›ï¼š
```json
[
  {
    "id": 1,
    "event_type": "circuit_breaker_triggered",
    "strategy_id": null,
    "message": "å…¨å±€å›æ’¤ -16.2% è¶…è¿‡é˜ˆå€¼ -15% | å†·å´è‡³ 2026-02-14 12:00:00",
    "created_at": "2026-02-13T12:00:00"
  }
]
```

### 3.5 æ‰‹åŠ¨è§£é™¤ç†”æ–­

```bash
curl -X POST http://localhost:8080/api/risk/release-circuit-breaker
```

è¿”å›ï¼š
```json
{"status": "ok", "message": "ç†”æ–­å·²æ‰‹åŠ¨è§£é™¤"}
```

> **è­¦å‘Š**: æ‰‹åŠ¨è§£é™¤æ„å‘³ç€ä½ è®¤ä¸ºå¸‚åœºå·²æ¢å¤æ­£å¸¸ï¼Œç³»ç»Ÿä¼šç«‹å³æ¢å¤äº¤æ˜“ã€‚è¯·è°¨æ…æ“ä½œã€‚

### 3.6 é£æ§äº‹ä»¶ç±»å‹ä¸€è§ˆ

| event_type | å«ä¹‰ | ä¸¥é‡ç¨‹åº¦ |
|------------|------|----------|
| `circuit_breaker_triggered` | ç†”æ–­è§¦å‘ | ä¸¥é‡ |
| `circuit_breaker_released` | ç†”æ–­è§£é™¤ï¼ˆè‡ªåŠ¨æˆ–æ‰‹åŠ¨ï¼‰ | ä¿¡æ¯ |
| `circuit_breaker_reject` | ç†”æ–­æœŸé—´æ‹’ç»ä¿¡å· | è­¦å‘Š |
| `max_drawdown_breach` | å›æ’¤è¶…è¿‡é˜ˆå€¼ | ä¸¥é‡ |
| `daily_loss_limit` | æ—¥äºæŸè¶…é™ | è­¦å‘Š |
| `max_exposure_reject` | æ€»æš´éœ²è¶…é™ï¼Œæ‹’ç»ä¹°å…¥ | è­¦å‘Š |
| `signal_rejected` | ä¿¡å·è¢«é£æ§æ‹’ç»ï¼ˆé€šç”¨ï¼‰ | è­¦å‘Š |

---

## 4. æ­¢æŸæ­¢ç›ˆå¼•æ“

### 4.1 è‡ªåŠ¨è¡¥å……é€»è¾‘

å¦‚æœç­–ç•¥ä¿¡å·ï¼ˆStrategySignalï¼‰æ²¡æœ‰è®¾ç½® `stop_loss` æˆ– `take_profit`ï¼Œé£æ§ç³»ç»Ÿä¼š**è‡ªåŠ¨è¡¥å……**ï¼š

| æ–¹å‘ | æ­¢æŸ (é»˜è®¤) | æ­¢ç›ˆ (é»˜è®¤) |
|------|------------|------------|
| ä¹°å…¥ (BUY) | å…¥åœºä»· Ã— (1 - 5%) = å…¥åœºä»· - 5% | å…¥åœºä»· Ã— (1 + 10%) = å…¥åœºä»· + 10% |
| å–å‡º (SELL) | å…¥åœºä»· Ã— (1 + 5%) = å…¥åœºä»· + 5% | å…¥åœºä»· Ã— (1 - 10%) = å…¥åœºä»· - 10% |

**ç¤ºä¾‹ï¼š** BTC å…¥åœºä»· $95,000
- è‡ªåŠ¨æ­¢æŸ: $90,250 (ä¸‹è·Œ 5%)
- è‡ªåŠ¨æ­¢ç›ˆ: $104,500 (ä¸Šæ¶¨ 10%)

### 4.2 ç­–ç•¥å¯ä»¥è‡ªå®šä¹‰æ­¢æŸ

ç­–ç•¥åœ¨è¿”å› `StrategySignal` æ—¶å¯ä»¥ç›´æ¥è®¾ç½®ï¼š

```python
return StrategySignal(
    signal=SignalType.BUY,
    conviction_score=75,
    position_size=0.15,
    reason="EMA å¤šå¤´æ’åˆ—",
    stop_loss=92000,       # è‡ªå®šä¹‰æ­¢æŸ
    take_profit=110000,    # è‡ªå®šä¹‰æ­¢ç›ˆ
)
```

å¦‚æœç­–ç•¥å·²è®¾ç½®æ­¢æŸ/æ­¢ç›ˆï¼Œé£æ§ç³»ç»Ÿ**ä¸ä¼šè¦†ç›–**ã€‚

### 4.3 æ­¢æŸç±»å‹

ç³»ç»Ÿæ”¯æŒä¸‰ç§æ­¢æŸæ¨¡å¼ï¼ˆé€šè¿‡ä»£ç é…ç½®ï¼Œé»˜è®¤ä¸ºå›ºå®šç™¾åˆ†æ¯”ï¼‰ï¼š

| ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `fixed_percent` | å›ºå®šç™¾åˆ†æ¯”æ­¢æŸ (é»˜è®¤ 5%) | é€šç”¨ |
| `atr_multiple` | ATR Ã— å€æ•°æ­¢æŸ (é»˜è®¤ 2 å€ ATR) | æ³¢åŠ¨ç‡è‡ªé€‚åº” |
| `trailing` | è¿½è¸ªæ­¢æŸ (ä»æœ€é«˜ç‚¹å›æ’¤ 3%) | è¶‹åŠ¿è·Ÿè¸ª |

---

## 5. ä»“ä½è®¡ç®—å™¨

ä¸‰ç§ä»“ä½è®¡ç®—ç­–ç•¥å¯é€‰ï¼ˆé»˜è®¤ä½¿ç”¨ FixedPercentï¼‰ï¼š

### 5.1 FixedPercentSizerï¼ˆé»˜è®¤ï¼‰

æ¯ç¬”äº¤æ˜“é£é™©å›ºå®šä¸ºè´¦æˆ·ä»·å€¼çš„ 2%ã€‚

- æœ‰æ­¢æŸæ—¶: `ä»“ä½ = é£é™©é‡‘é¢ / é£é™©æ¯”ä¾‹`
- æ— æ­¢æŸæ—¶: ç›´æ¥ç”¨é£é™©é‡‘é¢
- æ ¹æ®ä¿¡å¿µå¼ºåº¦ (conviction) å¾®è°ƒ: 50 åˆ† = åŸºç¡€, 100 åˆ† = 1.5 å€

**ç¤ºä¾‹:** è´¦æˆ· $100,000, å…¥åœº $95,000, æ­¢æŸ $90,000
- é£é™©é‡‘é¢ = $100,000 Ã— 2% = $2,000
- é£é™©æ¯”ä¾‹ = ($95,000 - $90,000) / $95,000 = 5.26%
- ä»“ä½ä»·å€¼ = $2,000 / 5.26% = $38,000
- ä¸Šé™: ä¸è¶…è¿‡è´¦æˆ· 30%

### 5.2 KellySizer

åŸºäºå‡¯åˆ©å…¬å¼ï¼Œéœ€è¦å†å²èƒœç‡å’Œç›ˆäºæ¯”è¾“å…¥ã€‚

### 5.3 AtrSizer

åŸºäº ATR (Average True Range) æ³¢åŠ¨ç‡ï¼Œæ³¢åŠ¨è¶Šå¤§ä»“ä½è¶Šå°ã€‚

> æ³¨æ„: ä»“ä½è®¡ç®—å™¨ç›®å‰åœ¨é£æ§æ¨¡å—ä¸­å¯ç”¨ï¼Œä½† scheduler å°šæœªè‡ªåŠ¨è°ƒç”¨å®ƒè°ƒæ•´ä»“ä½å¤§å°ï¼ˆç­–ç•¥è¿”å›çš„ position_size ä»ç„¶ç”Ÿæ•ˆï¼‰ã€‚è®¡åˆ’åœ¨ Phase 3C ç»„åˆç®¡ç†ä¸­å®Œæ•´é›†æˆã€‚

---

## 6. æ•°æ®è´¨é‡æ ¡éªŒ

### 6.1 æ£€æŸ¥å†…å®¹

`core/data_quality.py` åœ¨æ•°æ®è¿›å…¥ç­–ç•¥åˆ†æå‰è¿›è¡Œè´¨é‡æ£€æŸ¥ï¼š

| æ£€æŸ¥é¡¹ | è§„åˆ™ | æ•ˆæœ |
|--------|------|------|
| K çº¿è¿ç»­æ€§ | ç›¸é‚» K çº¿é—´éš” > é¢„æœŸé—´éš” Ã— 1.5 | æ ‡è®°ç¼ºå¤±ï¼Œè®°å…¥ `missing_bars` |
| å¼‚å¸¸æ¶¨è·Œå¹… | å•æ ¹ K çº¿æ¶¨è·Œ > 50% | æ ‡è®°å¯ç–‘ï¼Œè®°å…¥ `suspicious_bars`ï¼ˆä¸åˆ é™¤ï¼‰ |
| æ—¶é—´æˆ³å¯¹é½ | æ‰€æœ‰æ—¶é—´æˆ³ç»Ÿä¸€ä¸º UTC | è‡ªåŠ¨è½¬æ¢ |

### 6.2 è´¨é‡åˆ†æ•°

è¾“å‡º `DataQualityReport`:

```python
completeness: float   # 0-1, æ•°æ®å®Œæ•´åº¦ (1.0 = å®Œç¾)
missing_bars: int     # ç¼ºå¤± K çº¿æ•°
suspicious_bars: int  # å¯ç–‘ K çº¿æ•°
is_reliable: bool     # completeness >= 0.8 ä¸”æ— å¯ç–‘
```

ç­–ç•¥å¯ä»¥é€šè¿‡ `MarketContext.data_quality` è®¿é—®æ­¤æŠ¥å‘Šï¼Œæ ¹æ®æ•°æ®è´¨é‡å†³å®šæ˜¯å¦é™ä½äº¤æ˜“ä¿¡å¿µã€‚

### 6.3 å½“å‰é›†æˆçŠ¶æ€

æ•°æ®è´¨é‡æ£€æŸ¥å™¨å·²åˆ›å»ºï¼ŒMarketContext å·²æ”¯æŒ `data_quality` å­—æ®µã€‚å®Œæ•´çš„è‡ªåŠ¨é›†æˆï¼ˆåœ¨ scheduler æ•°æ®é‡‡é›†ç®¡é“ä¸­è‡ªåŠ¨è°ƒç”¨ï¼‰è®¡åˆ’åœ¨ Phase 3Bï¼ˆFeature Storeï¼‰ä¸­å®ç°ã€‚ç°é˜¶æ®µç­–ç•¥å¯ä»¥æ‰‹åŠ¨è°ƒç”¨ï¼š

```python
from core.data_quality import data_quality_checker
cleaned_klines, report = data_quality_checker.check_klines(klines, "1h")
```

---

## 7. Telegram é€šçŸ¥

### 7.1 è®¾ç½®æ­¥éª¤

1. åœ¨ Telegram ä¸­æœç´¢ `@BotFather`ï¼Œå‘é€ `/newbot` åˆ›å»ºæœºå™¨äºº
2. è·å– Bot Tokenï¼ˆæ ¼å¼: `123456:ABC-DEF...`ï¼‰
3. ä¸ä½ çš„ Bot å¯¹è¯ï¼Œå‘é€ä»»æ„æ¶ˆæ¯
4. è®¿é—® `https://api.telegram.org/bot<TOKEN>/getUpdates` è·å– Chat ID
5. åœ¨ `.env` ä¸­é…ç½®ï¼š

```bash
TELEGRAM_BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
TELEGRAM_CHAT_ID=987654321
```

6. é‡å¯æœåŠ¡

### 7.2 é€šçŸ¥ç±»å‹

| ç±»å‹ | è§¦å‘æ—¶æœº | å†…å®¹ç¤ºä¾‹ |
|------|----------|----------|
| äº¤æ˜“é€šçŸ¥ | æ¯ç¬”äº¤æ˜“æ‰§è¡Œå | `ğŸŸ¢ ğŸ“‹ æ¨¡æ‹Ÿ BUY BTC` + ä»·æ ¼/æ•°é‡/æ­¢æŸ/æ­¢ç›ˆ |
| é£æ§å‘Šè­¦ | ä¿¡å·è¢«æ‹’ç»/ç†”æ–­è§¦å‘ | `ğŸš¨ é£æ§å‘Šè­¦: circuit_breaker_triggered` |
| æ¯æ—¥æ‘˜è¦ | è®¡åˆ’ä¸­ (Phase 3) | æ€»ä»·å€¼/æ—¥ç›ˆäº/äº¤æ˜“ç¬”æ•°/æ´»è·ƒç­–ç•¥æ•° |

### 7.3 ä¸é…ç½®ä¼šæ€æ ·

å®Œå…¨ä¸å½±å“ç³»ç»Ÿè¿è¡Œã€‚é€šçŸ¥æ¨¡å—æ£€æµ‹åˆ° Token/ChatID ä¸ºç©ºæ—¶è‡ªåŠ¨ç¦ç”¨ï¼Œä¸ä¼šæŠ¥é”™ã€‚

---

## 8. æ–°å¢ API ç«¯ç‚¹

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/risk/status` | é£æ§çŠ¶æ€ï¼ˆç†”æ–­/é…ç½®/æ—¥å†…PnLï¼‰ |
| POST | `/api/risk/release-circuit-breaker` | æ‰‹åŠ¨è§£é™¤ç†”æ–­ |
| GET | `/api/risk/events?limit=50` | é£æ§äº‹ä»¶å†å² |
| GET | `/api/portfolio/snapshots?limit=168` | ç»„åˆå‡€å€¼å¿«ç…§ï¼ˆé»˜è®¤ 7 å¤©ï¼‰ |

### ç¤ºä¾‹ç”¨æ³•

```bash
# æŸ¥çœ‹é£æ§æ˜¯å¦æ­£å¸¸
curl -s http://localhost:8080/api/risk/status | python -m json.tool

# æŸ¥çœ‹æœ€è¿‘çš„é£æ§äº‹ä»¶
curl -s http://localhost:8080/api/risk/events?limit=10 | python -m json.tool

# æŸ¥çœ‹å‡€å€¼èµ°åŠ¿æ•°æ® (é€‚åˆæ¥å…¥å›¾è¡¨)
curl -s http://localhost:8080/api/portfolio/snapshots?limit=24 | python -m json.tool

# ç´§æ€¥è§£é™¤ç†”æ–­
curl -X POST http://localhost:8080/api/risk/release-circuit-breaker
```

---

## 9. æ•°æ®åº“æ–°å¢è¡¨

Phase 1 æ–°å¢ 3 å¼ è¡¨ï¼Œé€šè¿‡ `init_db()` è‡ªåŠ¨åˆ›å»ºï¼ˆé‡å¯æœåŠ¡æ—¶è‡ªåŠ¨æ‰§è¡Œï¼‰ï¼š

### 9.1 kline_cacheï¼ˆK çº¿ç¼“å­˜ï¼‰

å­˜å‚¨å†å² K çº¿æ•°æ®ï¼Œå›æµ‹å¼•æ“æ¶ˆè´¹ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| symbol | String | å¦‚ "BTCUSDT" |
| interval | String | å¦‚ "1h", "4h" |
| open_time | BigInteger | æ¯«ç§’æ—¶é—´æˆ³ |
| open/high/low/close | Numeric | OHLC ä»·æ ¼ |
| volume | Numeric | æˆäº¤é‡ |

è”åˆå”¯ä¸€ç´¢å¼•: `(symbol, interval, open_time)`

### 9.2 risk_eventsï¼ˆé£æ§äº‹ä»¶ï¼‰

æ‰€æœ‰é£æ§æ‹¦æˆª/ä¿®æ”¹/ç†”æ–­äº‹ä»¶çš„å®¡è®¡è®°å½•ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| event_type | String | äº‹ä»¶ç±»å‹ï¼ˆè§ 3.6 è¡¨æ ¼ï¼‰ |
| strategy_id | Integer | å…³è”ç­–ç•¥ï¼ˆå…¨å±€äº‹ä»¶ä¸º nullï¼‰ |
| details | JSON | äº‹ä»¶è¯¦ç»†æ•°æ® |
| message | String | ç®€è¦æè¿° |
| created_at | DateTime | äº‹ä»¶æ—¶é—´ |

### 9.3 portfolio_snapshotsï¼ˆç»„åˆå¿«ç…§ï¼‰

æ¯å°æ—¶è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ï¼Œç”¨äºå‡€å€¼æ›²çº¿å’Œå›æ’¤è®¡ç®—ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| total_value | Numeric | ç»„åˆæ€»ä»·å€¼ (USDT) |
| total_pnl | Numeric | æ€»ç›ˆäº |
| total_pnl_percent | Numeric | ç›ˆäºç™¾åˆ†æ¯” |
| positions_json | JSON | å„ç­–ç•¥æŒä»“å¿«ç…§ |
| drawdown_from_peak | Numeric | ä»å³°å€¼çš„å›æ’¤ |
| circuit_breaker_active | Boolean | å¿«ç…§æ—¶ç†”æ–­æ˜¯å¦æ¿€æ´» |
| snapshot_at | DateTime | å¿«ç…§æ—¶é—´ |

---

## 10. å¯¹ç°æœ‰åŠŸèƒ½çš„å½±å“

### 10.1 å¯¹ç”¨æˆ·çš„å½±å“

| æ–¹é¢ | ä¹‹å‰ | Phase 1 ä¹‹å |
|------|------|-------------|
| ç­–ç•¥æ‰§è¡Œ | ä¿¡å·ç›´æ¥æ‰§è¡Œ | ä¿¡å·ç»è¿‡é£æ§è¯„ä¼°åæ‰§è¡Œ |
| æ­¢æŸ | æ—  | è‡ªåŠ¨è¡¥å……ï¼ˆç­–ç•¥æœªè®¾ç½®æ—¶ï¼‰ |
| å¼‚å¸¸ä¿æŠ¤ | æ—  | å›æ’¤è¶… 15% è‡ªåŠ¨ç†”æ–­ 24h |
| é€šçŸ¥ | æ—  | Telegram å®æ—¶æ¨é€ï¼ˆéœ€é…ç½®ï¼‰ |
| å®¡è®¡ | ä»… trades è¡¨ | æ–°å¢ risk_events å’Œ portfolio_snapshots |
| API | åŸºç¡€ | æ–°å¢ 4 ä¸ªé£æ§/ç»„åˆ API |

### 10.2 å¯¹ç­–ç•¥çš„å½±å“

**å®Œå…¨å‘åå…¼å®¹ã€‚** ç°æœ‰ä¸‰ä¸ªç­–ç•¥ï¼ˆTA/Macro/Gridï¼‰æ— éœ€ä»»ä½•æ”¹åŠ¨ï¼š

- `StrategySignal` æ–°å¢çš„å­—æ®µï¼ˆstop_loss/take_profit/urgency ç­‰ï¼‰éƒ½æœ‰é»˜è®¤å€¼
- `BaseStrategy.analyze()` ç­¾åæ”¹ä¸º `analyze(self, market_data=None)`ï¼Œç°æœ‰ç­–ç•¥å·²ä½¿ç”¨ `=None` é»˜è®¤å€¼
- ç­–ç•¥ä»ç„¶è‡ªè¡Œè·å–æ•°æ®ï¼ˆPhase 3 æ‰æ”¹ä¸ºç”± FeatureStore æä¾›ï¼‰

### 10.3 å¯¹æ€§èƒ½çš„å½±å“

- é£æ§è¯„ä¼°: < 1msï¼ˆçº¯å†…å­˜è®¡ç®—ï¼‰
- æ­¢æŸè¡¥å……: < 0.1ms
- ç»„åˆå¿«ç…§: æ¯å°æ—¶ä¸€æ¬¡æ•°æ®åº“å†™å…¥ï¼ˆæ¯«ç§’çº§ï¼‰
- é£æ§äº‹ä»¶: æ¯ 5 åˆ†é’Ÿæ‰¹é‡å†™å…¥ï¼ˆé€šå¸¸ 0 æ¡ï¼‰
- Telegram é€šçŸ¥: å¼‚æ­¥å‘é€ï¼Œä¸é˜»å¡ä¸»æµç¨‹

**ç»“è®º: æ€§èƒ½å½±å“å¯å¿½ç•¥ä¸è®¡ã€‚**

---

## 11. æ•…éšœæ’æŸ¥

### Q: ç­–ç•¥ä¿¡å·ä¸€ç›´è¢«æ‹’ç»

æ£€æŸ¥æ˜¯å¦è§¦å‘äº†ç†”æ–­ï¼š

```bash
curl http://localhost:8080/api/risk/status
```

å¦‚æœ `circuit_breaker.active = true`ï¼Œå¯ä»¥ç­‰å¾…å†·å´æœŸç»“æŸæˆ–æ‰‹åŠ¨è§£é™¤ã€‚

### Q: çœ‹ä¸åˆ° Telegram é€šçŸ¥

1. ç¡®è®¤ `.env` ä¸­ `TELEGRAM_BOT_TOKEN` å’Œ `TELEGRAM_CHAT_ID` å·²é…ç½®
2. ç¡®è®¤å·²é‡å¯æœåŠ¡
3. æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `Telegram send failed` é”™è¯¯
4. ç¡®è®¤ Bot å·²è¢«æ·»åŠ åˆ°å¯¹è¯ä¸­ï¼ˆéœ€å…ˆç»™ Bot å‘ä¸€æ¡æ¶ˆæ¯ï¼‰

### Q: æ•°æ®åº“æŠ¥é”™æ–°è¡¨ä¸å­˜åœ¨

é‡å¯æœåŠ¡æ—¶ `init_db()` ä¼šè‡ªåŠ¨åˆ›å»ºæ–°è¡¨ã€‚å¦‚æœä»æŠ¥é”™ï¼Œæ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
cd AutoM2026
source venv/bin/activate
python -c "from core.database import init_db_sync; init_db_sync()"
```

### Q: æƒ³è°ƒæ•´é£æ§å‚æ•°

ä¿®æ”¹ `.env` ä¸­çš„ `RISK_*` é…ç½®é¡¹åé‡å¯æœåŠ¡ã€‚ä¾‹å¦‚æ”¾å®½å›æ’¤é™åˆ¶ï¼š

```bash
RISK_MAX_DRAWDOWN_PCT=0.25   # ä» 15% æ”¾å®½åˆ° 25%
RISK_COOLDOWN_HOURS=12       # å†·å´æœŸä» 24h ç¼©çŸ­åˆ° 12h
```

### Q: æ—¥å¿—ä¸­çœ‹åˆ° `[Risk]` å‰ç¼€çš„æ¶ˆæ¯

è¿™æ˜¯æ­£å¸¸çš„ã€‚é£æ§ç³»ç»Ÿçš„æ—¥å¿—å‰ç¼€ä¸º `[Risk]`ï¼Œç­‰çº§è¯´æ˜ï¼š

- `INFO` â€” ä¿¡å·é€šè¿‡è¯„ä¼°
- `WARNING` â€” ä¿¡å·è¢«æ‹’ç»
- `CRITICAL` â€” ç†”æ–­è§¦å‘

---

## æ–‡ä»¶æ¸…å•

```
Phase 1 æ–°å¢/ä¿®æ”¹æ–‡ä»¶:

core/
â”œâ”€â”€ market_context.py     [æ–°å»º] MarketContext ç»Ÿä¸€ç­–ç•¥è¾“å…¥
â”œâ”€â”€ data_quality.py       [æ–°å»º] æ•°æ®è´¨é‡æ£€æŸ¥å™¨
â”œâ”€â”€ scheduler.py          [é‡å†™] å®Œæ•´æµç¨‹ Strategyâ†’Riskâ†’Executeâ†’Notify

risk/
â”œâ”€â”€ __init__.py           [æ–°å»º] é£æ§æ¨¡å—å…¥å£
â”œâ”€â”€ position_sizer.py     [æ–°å»º] 3ç§ä»“ä½è®¡ç®— (Fixed/Kelly/ATR)
â”œâ”€â”€ risk_manager.py       [æ–°å»º] é£æ§è§„åˆ™ + ç†”æ–­å†·å´
â”œâ”€â”€ stop_loss.py          [æ–°å»º] æ­¢æŸå¼•æ“

execution/
â”œâ”€â”€ __init__.py           [ä¿®æ”¹] å¯¼å‡ºæ–°åŸºç±»
â”œâ”€â”€ base.py               [æ–°å»º] ExecutionEngine ABC
â”œâ”€â”€ paper_engine.py       [ä¿®æ”¹] ç»§æ‰¿åŸºç±» + execute_signal()

models/
â”œâ”€â”€ __init__.py           [ä¿®æ”¹] æ³¨å†Œ 3 ä¸ªæ–°æ¨¡å‹
â”œâ”€â”€ kline_cache.py        [æ–°å»º] Kçº¿ç¼“å­˜è¡¨
â”œâ”€â”€ risk_event.py         [æ–°å»º] é£æ§äº‹ä»¶è¡¨
â”œâ”€â”€ portfolio_snapshot.py [æ–°å»º] ç»„åˆå¿«ç…§è¡¨

notifications/
â”œâ”€â”€ __init__.py           [æ–°å»º] é€šçŸ¥æ¨¡å—å…¥å£
â”œâ”€â”€ telegram.py           [æ–°å»º] Telegram Bot

strategies/
â”œâ”€â”€ base.py               [ä¿®æ”¹] StrategySignal æ‰©å±• 6 ä¸ªå­—æ®µ

config/
â”œâ”€â”€ settings.py           [ä¿®æ”¹] æ–°å¢é£æ§/Telegram é…ç½®

web/
â”œâ”€â”€ app.py                [ä¿®æ”¹] æ–°å¢ 4 ä¸ª API ç«¯ç‚¹
```
